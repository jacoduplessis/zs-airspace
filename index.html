<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>South African Airspace</title>
  <link rel="stylesheet" href="static/leaflet.css">
  <link rel="stylesheet" href="static/leaflet.draw.css">
</head>

<body>

<div id="map" style="width: 100%; height: 80vh"></div>
<p>Data Source: <a href="https://www.atns.co.za/rsakmz.php">https://www.atns.co.za/rsakmz.php</a></p>

<script src="static/leaflet.js"></script>
<script src="static/leaflet.draw.js"></script>
<script src="static/turf.min.js"></script>
<script src="static/topojson.min.js"></script>
<script>

  var map = L.map('map', {
    center: [-29, 25],
    zoom: 6,
    zoomControl: false,
    renderer: L.canvas(),
  })

  var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
  var tileLayer = new L.TileLayer(osmUrl, {attribution: osmAttrib});
  var noneLayer = new L.TileLayer('')

  var layerControl = L.control.layers(
    {"Tiles": tileLayer, "None": noneLayer}, {}, {collapsed: false}
  )
  layerControl.addTo(map)

  function popUpContent(feature) {
    const container = document.createElement('p')
    Object.entries(feature.properties).map(([key, val]) => {
      container.innerHTML += `<strong>${key}</strong>: ${val}<br>`
    })
    return container
  }

  fetch("data/za-provinces.topojson").then(r => r.json()).then(data => {

    const geo = topojson.feature(data, data.objects.layer1)
    const layer = L.geoJSON(geo, {
      style: {
        opacity: 1,
        fillColor: 'black',
        fillOpacity: 0.3,
        stroke: true,
        color: 'black'
      }
    })
    layer.addTo(map)
  })

  fetch("data/doc.geojson").then(r => r.json()).then(data => {

    const points = data.features.filter(f => f.geometry.type === 'Point')
    const firs = data.features.filter(f => f.properties.name.indexOf("FIR") >= 0 && f.geometry.type === 'Polygon').slice(0, 3)
    const faps = data.features.filter(f => /^FAP\d/.test(f.properties.name) && f.geometry.type === 'Polygon')
    const fads = data.features.filter(f => /^FAD\d/.test(f.properties.name) && f.geometry.type === 'Polygon')
    const fars = data.features.filter(f => /^FAR\d/.test(f.properties.name) && f.geometry.type === 'Polygon')
    const ctrs = data.features.filter(f => /CTR/.test(f.properties.name) && f.geometry.type === 'Polygon')
    const tmas = data.features.filter(f => /TMA/.test(f.properties.name) && /Freq/.test(f.properties.description) && f.geometry.type === 'Polygon')

    const zones = {
      'FIR': {features: firs, options: {fillColor: 'blue'}},
      'FAP': {features: faps, options: {color: 'red'}},
      'FAD': {features: fads, options: {color: 'orange'}},
      'FAR': {features: fars, options: {color: 'yellow'}},
      'CTR': {features: ctrs, options: {color: 'purple'}},
      'TMA': {features: tmas, options: {color: 'green'}},
    }

    Object.entries(zones).forEach(([key, val]) => {
      const layer = L.geoJSON({
        type: "FeatureCollection",
        features: val.features,
      }, val.options)
      layer.bindPopup(layer => popUpContent(layer.feature))
      layerControl.addOverlay(layer, key)
    })

    const pointsCollections = {
      type: "FeatureCollection",
      features: points,
    }

    window.dataLayer = L
      .geoJSON(pointsCollections, {
        pointToLayer: function (feature) {
          return new L.circleMarker(feature.geometry.coordinates.slice(0, 2).reverse(), {
            radius: 2,
            color: '#4d4d4d',
          })
        },
      })
      .bindPopup(layer => popUpContent(layer.feature))

    layerControl.addOverlay(dataLayer, 'Points')
  })

  var editableLayers = new L.FeatureGroup();
  map.addLayer(editableLayers);


  var drawOptions = {
    position: 'bottomright',
    draw: {
      polygon: {
        allowIntersection: false, // Restricts shapes to simple polygons
        drawError: {
          color: '#e1e100', // Color the shape will turn when intersects
          message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
        },
        shapeOptions: {
          color: '#bada55'
        }
      },
      circle: false, // Turns off this drawing tool
      rectangle: {
        shapeOptions: {
          clickable: false
        }
      },
      polyline: {
        nautic: true,
        feet: false,
        metric: false,
      }
    },
    edit: {
      featureGroup: editableLayers,
      remove: true,
    }
  };

  var drawControl = new L.Control.Draw(drawOptions);

  map.addControl(drawControl);

  function exportDraw() {
    prompt("GeoJSON export", JSON.stringify(editableLayers.toGeoJSON()))
  }

  map.on(L.Draw.Event.CREATED, function (e) {
    var type = e.layerType,
      layer = e.layer;

    if (type === 'marker') {
      layer.bindPopup('A popup!');
    }

    if (type === 'polyline') {

      const geo = layer.toGeoJSON()
      console.log(turf.length(geo, {units: 'nauticalmiles'}))
    }

    editableLayers.addLayer(layer);
  });


</script>
</body>
</html>